---
title: "BioCor"
author: '[Lluís Revilla](mailto:lrevilla@clinic.cat)'
date: '`r date()`'
output:
  BiocStyle::pdf_document:
    fig_caption: yes
    toc: yes
  BiocStyle::html_document:
    fig_caption: yes
    toc_float: yes
package: '`r BiocStyle::pkg_ver("BioCor")`'
vignette: "%\\VignetteIndexEntry{BioCor} %\\VignetteEngine{knitr::rmarkdown} %\\VignetteEncoding{UTF-8}
  \ \n"
---
```{r knitsetup, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(fig.width = 20, fig.height = 20, collapse = TRUE)
```


# Introduction

The main purpouse of this package is to calculate a "functional" similarity based on the methabolic pathways of genes. A different funcional similarity based on Gene Ontologies can be calculated using [GOSemSim](https://bioconductor.org/packages/release/bioc/html/GOSemSim.html).

It also provides some functions to combine several similarities and create a new similarity of several ones. As it development started aiming to group better genes by functionallity in co-expression networks using [WGCNA](https://cran.r-project.org/package=WGCNA).

# Citation
The main article describing how it has been applied, is currently under writing.

# Installation
The BioCor package will be available at bioconductor.org and will be downloaded and installed via biocLite:
```{r install, eval=FALSE}
source("http://bioconductor.org/biocLite.R")
biocLite("BioCor")
```

You can install the latest version with:
```{r github, eval = FALSE}
library("devtools")
install_github("llrs/BioCor")
```

# Quick start
We can load the package:
```{r load}
library("BioCor")
```

To calculate a single pair of comparisons we can do:
```{r small}
# Load the libraries with the data
library("org.Hs.eg.db")
library("reactome.db")
# Prepare the data
entrezids <- keys(org.Hs.eg.db, keytype = "ENTREZID")
genes.kegg <- select(org.Hs.eg.db, keys = entrezids, keytype = "ENTREZID", 
                     columns = "PATH")
genes.react <- select(reactome.db, keys = entrezids, keytype = "ENTREZID", 
                      columns = "REACTOMEID")
# Run the Similarity functions 
genesSim("81", "18", genes.kegg, "ENTREZID", "PATH") # KEGG
genesSim("81", "18", genes.react, "ENTREZID", "REACTOMEID") # REACTOME
```

If we want multiple pair-wise comparisons we can use bioCor, which accepts a parallel back-end and both from the REACTOME database and from KEGG database:
```{r big, collapse=TRUE}
genes.id <- c("10", "15", "16", "18", "2", "9", "52", "3855", "3880", "644", 
              "81327", "9128", "2073", "2893", "5142", "60", "210", "81", 
              "1352", "88")
library("BiocParallel")
sim <- bioCor(genes.id, all = TRUE, BPPARAM = MulticoreParam())
sim
```

Now in `sim` we have a list of matrices of `r nrow(sim)` rows and columns. 

# FAQ
## How do you calculate how similar two genes are ?
It uses the [Sørensen–Dice index](https://en.wikipedia.org/wiki/S%C3%B8rensen%E2%80%93Dice_coefficient): 
It is the top score of the doble of the genes shared by pathways of the two genes ($i$ and $j$) divided by the number of genes in each pathway.

We can calculate the similarity between two pathways ($x$, $w$) with:

$sim(x, w) = \frac{2 · |x \cap y|}{|x| + |y|}$

This is implemented in the `pathSim` function, which results is similar to Jaccard index:

$J(x, w) = \frac{|x \cap w|}{|x \cup w|}$

If one want to calculate the Jaccard index, can use the `D2J` function.

The resulting values are $sim(x, w)  \in [0, 1]$. To calculate the similarity between two genes is implemented in the `genesSim` function.

## Why does it uses the maximum to calculate the bioCor?

This measure is intended to simulate how close are the function of two genes in the pathways where they are described. The higher the similarity is in a pathway the higher they relate. Certainly some genes might not have a principal function or have several diverse functions, but those relationships if important should be caught by the correlation of the expression of both genes. 

## How do you combine scores between two genes with several pathways?
Although I recommend the "max" method (Which is the default) there are implemented others in the `combineScores` of the `GOSemSim`package which I borrowed.

## How does bioCor deal when one gene is mapped to several ones?
It keeps the one with the higher mean similarity for all the genes available in the comparison. That means that for a different comparison depending on which genes you are computing a gene can have different values. 

## Why isn't available a method for calculating GO ?
This is covered by the GOSemSim package, you can use it to produce a similarity matrix (i.e. use `mgeneSim`). You can parallelize it with `foreach` package or `BiocParallel` if your list of genes is big. 

# WGCNA and BioCor 

BioCor, is thought to be used with other clustering packages using similarity measures like WGCNA, does. Here we provide an example on how to use BioCor to improve the modules using WGCNA:

```{r wgcna, eval=FALSE}
# Load the expression data
load("expression.RData", verbose = TRUE)
expr.sim <- adjacency(expr) # set the power necessary for a scale free topology
# To combine the similarities we can use several functions:
similarity <- addSimilarities(expr.sim, sim, w = c(0.8, 0.1, 0.1))
# Equivalent to the previous one
similarity <- similarities(c(list(exp = expr.sim), sim), 
                           weighted.sum, w = c(0.8, 0.1, 0.1))
# Multiply each similarity to keep the sign if we use 
# adjacency type = "unsigned" for TOMType  = "signed"
similarity <- similarities(c(list(exp = expr.sim), sim), prod) 

# Once we have the similarities we can calculate the TOM with TOM
TOM <- TOMsimilarity(similarity)
dissTOM <- 1 - TOM
geneTree <- hclust(as.dist(dissTOM), method = "average")
# We can use the recomended way of WGCNA or any other clustering tool
dynamicMods <- cutreeHybrid(dendro = geneTree, distM = dissTOM,
                            deepSplit = 2, pamRespectsDendro = FALSE,
                            minClusterSize = 30)
moduleColors <- labels2colors(dynamicMods$labels) 
```
Once identified the modules using the functional similarities of this package, one can continue with the workflow of WGCNA.

# Session Info

```{r session}
sessionInfo()
```
